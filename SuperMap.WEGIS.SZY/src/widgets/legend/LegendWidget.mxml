<?xml version="1.0" encoding="utf-8"?>
<ns:WidgetBase xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx" 
			   xmlns:ns="library://ns.supermap.com/flex/wegis/common" 
			   creationComplete="initLegendManager(event)" 
			   xmlns:container="com.supermap.wegis.common.components.container.*">
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	<fx:Script>
		<![CDATA[
			import com.supermap.wegis.common.components.container.ContainerItem;
			import com.supermap.wegis.common.core.widget.WidgetBase;
			import com.supermap.wegis.common.core.widget.WidgetManager;
			
			import mx.collections.ArrayCollection;
			import mx.events.FlexEvent;
			
			import sm.wegis.szy.models.ApplicationModelLocator;
			import sm.wegis.szy.skins.MenuItemSkinEx;
			
			import spark.effects.Resize;
			
			[Bindable]
			private var modelLocator:ApplicationModelLocator  = ApplicationModelLocator.getInstance();
			
			[Embed(source="assets/image/legend/down.png")]
			private var downImage:Class;
			
			[Embed(source="assets/image/legend/up.png")]
			private var upImage:Class;
			
			/**图例面板顶部菜单项目高度*/
			[Bindable]
			public var menuHeight:Number = 25;
			
			/**图例面板顶部菜单项目宽度*/
			[Bindable]
			public var menuWidth:Number = 25;
			private var menuList:ArrayCollection=modelLocator.menuInfo.mapMenuList;
			//初始化管理器
			protected function initLegendManager(event:FlexEvent):void
			{
				// TODO Auto-generated method stub
				controlBtn.addEventListener(MouseEvent.CLICK, btnClickHandler);
				switchPanel();
				//添加子模块
				sysWidgetAddHandler();
			}
			private function sysWidgetAddHandler():void{
				containerManager.removeAllElements();
				containerManager.addElement(new ServiceLegend());
				this.visible=true;
				this.includeInLayout=true;
				LegendTitle.text="图例";
			}
			/**预加载模块*/
			private function preLoadWidget():void{
				
				if(menuList != null && menuList.length > 0)
				{
					for each (var data:Object in menuList) 
					{
						if(data != null && data.hasOwnProperty("init"))
						{
							if(data["init"])
							{
								if(data.hasOwnProperty("subitems") && data["subitems"])
								{
									var arr:ArrayCollection=data["subitems"]["subitem"] is  ArrayCollection ? data["subitems"]["subitem"] as  ArrayCollection
										: new ArrayCollection([data["subitems"]["subitem"]])
									if(arr&&arr.length>0&&arr.getItemAt(0).special){
										var item:Object =arr.getItemAt(0);
										modelLocator.specialWidgetInfo.specialWidgetMap.add(item["key"], item);
										var serviceLegend:Object = modelLocator.specialWidgetInfo.specialWidgetMap.itemFor("ServiceLegend");
										if(serviceLegend){
											 containerManager.addElement(new ServiceLegend());
											this.visible=true;
											this.includeInLayout=true; 
											LegendTitle.text=serviceLegend.name;
										}
										
										modelLocator.specialWidgetInfo.specialWidgetMap.clear();
									}
								}
							}
						}
					}
				}
			}
			//隐藏或显示面板
			private var isInit:Boolean = false;
			private var ow:Number = 0;
			private var oh:Number = 0;
			private function btnClickHandler(event:MouseEvent):void
			{
				switchPanel();
			}
			/**控制面板显示隐藏*/
			private function switchPanel():void{
				//创建特效
				var resizeEffect:Resize = new Resize();
				resizeEffect.duration = 500;
				resizeEffect.repeatCount = 1;
				resizeEffect.target = this;
				
				var w:Number = this.width;
				var h:Number = this.height;
				if(!isInit)
				{
					ow = w;
					oh = h;
					preLoadWidget();
					isInit = true;
				}
				var mw:Number = this.controlBtn.width;
				var mh:Number = this.controlBtn.height;
				
				if(w > mw)
				{
					resizeEffect.widthFrom = w;
					resizeEffect.widthTo = mw;
					resizeEffect.heightFrom = h;
					resizeEffect.heightTo = mh;
					
					this.width = mw;
					this.height = mh;
					
					this.controlBtn.setStyle("icon", upImage);
					
					containerManager.visible = false;
					containerManager.includeInLayout = false;
				}
				else
				{
					resizeEffect.widthFrom = mw;
					resizeEffect.widthTo = ow;
					resizeEffect.heightFrom = mh;
					resizeEffect.heightTo = oh;
					
					this.width = ow;
					this.height = oh;
					
					this.controlBtn.setStyle("icon", downImage);
					
					containerManager.visible = true;
					containerManager.includeInLayout = true;
				}
				
				resizeEffect.play();
			}
		]]>
	</fx:Script>
	<s:Rect width="100%" height="100%">
		<s:fill>
			<s:SolidColor color="#FFFFFF" alpha="{getStyle('backgroundAlpha')}"/>
		</s:fill>
		<s:stroke>
			<s:SolidColorStroke color="0xABAEB3" weight="1" alpha="1"/>
		</s:stroke>
	</s:Rect>
	<s:HGroup width="100%" height="100%" gap="0" verticalAlign="top" paddingTop="2" paddingLeft="2">
		<s:Button id="controlBtn" width="{menuWidth}" height="{menuHeight}"  skinClass="sm.wegis.szy.skins.ControlButtonSkin"  buttonMode="true"/>
		<s:Group width="100%" height="100%">
			<s:Label  id="LegendTitle"
					  width="100%"
					  height="25" fontSize="14" 
					  backgroundColor="#3385FF"
					  color="#FFFFFF"
					  verticalAlign="middle"
					  textAlign="left" />
			<s:Scroller left="0" bottom="0" right="0" top="{LegendTitle.height + 5}" >
				<s:Group id="containerManager" width="100%" height="100%" bottom="3"  clipAndEnableScrolling="true" />
			</s:Scroller>
		</s:Group>
	</s:HGroup>
</ns:WidgetBase>
